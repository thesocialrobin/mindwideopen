import wixData from 'wix-data';
import wixLocation from 'wix-location';
import wixWindow from 'wix-window';

let musicGenre = null;
musicGenre = [];

$w.onReady( () => {
    let search = wixLocation.query.search;
    console.log(search)
    //let searchWords = search.split(' ');  
    
    if(search == undefined || search === "") {
        $w('#repeater1').show();
    }
    else{
        $w('#searchStr').value = "" + search;

        //for (let i=0; i < searchWords.length; i++) 
        //{
            $w("#dataset1").setFilter( wixData.filter()
             .eq("language", "English")
             .contains("title", search)
             .or(
                   wixData.filter()
                   .eq("language", "English")
                   .contains("description", search)
                )
            )
            .then( () => {
              $w('#repeater1').show();
            })
        //}
    }
});

function myfilter() {
    let search = "" + $w('#searchStr').value;
    let category = $w('#categoryDropdown').value;

    //let searchWords = search.split(' ');  

    if(category === "Any"){ 

        //for (let i=0; i < searchWords.length; i++) 
        //{
            $w("#dataset1").setFilter( wixData.filter()
            .eq("language", "English")
            .contains("title", search)
                .or(
                    wixData.filter()
                   .eq("language", "English")
                   .contains("description", search)
                )
            )
            console.log("Any Cat")
        //}
    }
    else {

        //for (let i=0; i < searchWords.length; i++) 
        //{
            $w("#dataset1").setFilter( wixData.filter()
            .eq("language", "English")
            .contains("category", category)
            .contains("title", search)
                .or(
                    wixData.filter()
                   .eq("language", "English")
                   .contains("category", category)
                   .contains("description", search)
                )
            )
            console.log(category)
        //}
    }
}

export function search_click(event) {
    myfilter()
}

export function categoryDropdown_change(event) {
    myfilter()
}

export function categoryDropdown_click(event) {
    myfilter()
}

export function similar_click(event) { 
    let $item = $w.at(event.context);
    let data = $item("#dataset1").getCurrentItem();
    console.log(data)
    let category = data.category[0];

    $w("#dataset1").setFilter( wixData.filter()
     .eq("language", "English")
     .contains("category", category)
    )
    $w("#repeater1").scrollTo();
}


let searchDelay;

export function searchStr_keyPress(event) {
    /*
    if(event.key === "Enter"  ) {
      myfilter()
    }
    */

    if(searchDelay){
        clearTimeout(searchDelay);
        searchDelay = undefined;
    }

    searchDelay = setTimeout(()=>{
     console.log("Value: ", $w("#searchStr").value)
     loadMultiselect("MP3Database");

    },200)




}

export function loadMultiselect(dropdown){

    let search = $w('#searchStr').value;
    let category = $w('#categoryDropdown').value;
    let categoryValue = $w("#categoryDropdown").valid;
    console.log("Category Value: ", categoryValue);
    let str   = search;
    let stringArray = str.split(/(\s+)/).filter( function(e) { return e.trim().length > 0; });
    console.log("This String:", stringArray);

    if(category === "Any"){ 
        console.log("Any selected.");

        	wixData.query(dropdown)
					    .eq("language", "English")
                        //.contains("title", search)
                        .hasSome("title", stringArray)
					.or(
						wixData.query(dropdown)
							.eq("language", "English")
                            //.contains("description", search)
                            .hasSome("description", stringArray)
						)
					.find()
					.then((res2) => {
                        console.log("Found Items: ", res2, res2.items)

						if (res2.length > 0) {
                             let array = null;
						     array = [];
						     array = res2.items
                             console.log("Options Found: " + dropdown + ": ", array)

                        loadRepeater(dropdown, array);

						} 

					})

    } else {

        wixData.query(dropdown)
					    .eq("language", "English")
                        .contains("category", category)
                        //.contains("title", search)
                        .hasSome("title", stringArray)
					.or(
						wixData.query(dropdown)
							.eq("language", "English")
                            .contains("category", category)
                            //.contains("description", search)
                            .hasSome("description", stringArray)
						)
					.find()
					.then((res2) => {
                        console.log("Found Items: ", res2, res2.items)

						if (res2.length > 0) {
                             let array = null;
						     array = [];
						     array = res2.items
                             console.log("Options Found" + dropdown + ": ", array)

                        loadRepeater(dropdown, array);

						} 

					})

    }


					

}

export function loadRepeater(dropdown, array){


	//----MY PARTNER'S ABILITIES---//


	//----MUSIC GENRE---//

	if(dropdown === "MP3Database"){ //VARIABLE//
		$w("#musicGenre").data = array;  //VARIABLE//
		console.log("Array loaded: ", array)
        $w("#musicGenre").expand();



		$w("#musicGenre").onItemReady(($item, itemData) => {  //VARIABLE//


                                        let fileUrl = itemData.url;
                                        //let type = itemData.type;
                                        let title = itemData.title;
                                        //let download = itemData.downloadable;
                                        $item("#musicGenreOptions").text = title;  //VARIABLE//
                                        let thisTitle = $item("#musicGenreOptions").text;



                                        $item('#musicGenreOptions').onClick(async(event) => {   //VARIABLE//

											//--load repeater with searched clicked item---//

											loadClicked(dropdown, thisTitle);

											

                                        })

		})
	}

}

export function loadClicked(dropdown, thisTitle){

        let search = $w('#searchStr').value;
    let category = $w('#categoryDropdown').value;

    if(category === "Any"){ 
        console.log("Any selected.");
        
        wixData.query(dropdown)
					    .eq("language", "English")
                        .contains("title", thisTitle)
					.find()
					.then((res2) => {

						if (res2.length > 0) {
                             let array = null;
						     array = [];
						     array = res2.items
                             console.log("Clicked Options " + dropdown + ": ", array)

                        $w("#repeater1").data = array;
                        $w("#musicGenre").collapse();
                         $w("#searchStr").value = thisTitle;

						} 

					})

    } else {
        wixData.query(dropdown)
					    .eq("language", "English")
                        .contains("category", category)
                        .contains("title", thisTitle)
					.find()
					.then((res2) => {

						if (res2.length > 0) {
                             let array = null;
						     array = [];
						     array = res2.items[0]
                             console.log("Options " + dropdown + ": ", array)

                        $w("#repeater1").data = res2.items;
                        $w("#musicGenre").collapse();
                         $w("#searchStr").value = thisTitle;

						} 

					})

    }


					
}


export function repeater1_itemReady($item) {
    
    $w("#repeater1").forEachItem( ($item, itemData, index) => {
    
    let bestseller = itemData.bestseller;
    if(bestseller == true) {
        $item("#bestSeller").show();
    }
    else {
        $item("#bestSeller").hide();
    }
    } );
}
